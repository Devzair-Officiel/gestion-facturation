{# ============================================
   Template: pdf/invoice.html.twig
   Variables attendues:
   - company  : App\Entity\Company
   - invoice  : App\Entity\Invoice (avec invoice.lines)
   - customer : App\Entity\Customer (facultatif; sinon invoice.customer)
   ============================================ #}
{% macro money(cents, currency) %}
	{% set amount = ((cents ?? 0) / 100) %}
	{% if currency == 'EUR' %}
		{{ amount|number_format(2, ',', ' ') ~ ' €' }}
	{% else %}
		{{ amount|number_format(2, ',', ' ') ~ ' ' ~ currency }}
	{% endif %}
{% endmacro %}
{% import _self as ui %}

<!DOCTYPE html>
<html lang="fr">
	<head>
		<meta charset="utf-8">
		<title>Facture
			{{ invoice.number }}</title>
		<meta name="viewport" content="width=device-width, initial-scale=1">
		<style>
			html,
			body {
				font-family: Arial, Helvetica, sans-serif;
				font-size: 12px;
				color: #111;
			}
			.container {
				width: 100%;
				max-width: 760px;
				margin: 0 auto;
			}
			.flex {
				display: flex;
				gap: 24px;
			}
			.space-between {
				display: flex;
				justify-content: space-between;
				align-items: flex-start;
			}
			.muted {
				color: #666;
			}
			h1 {
				font-size: 22px;
				margin: 0 0 6px;
			}
			h2 {
				font-size: 14px;
				margin: 0 0 6px;
			}
			.box {
				border: 1px solid #ddd;
				padding: 12px;
				border-radius: 6px;
			}
			.mt-8 {
				margin-top: 8px;
			}
			.mt-16 {
				margin-top: 16px;
			}
			.mt-24 {
				margin-top: 24px;
			}
			.mb-0 {
				margin-bottom: 0;
			}

			table {
				width: 100%;
				border-collapse: collapse;
			}
			th,
			td {
				padding: 8px;
				border-bottom: 1px solid #eee;
				vertical-align: top;
			}
			th {
				background: #fafafa;
				text-align: left;
				font-weight: 600;
				border-top: 1px solid #eee;
			}
			tfoot td {
				border-top: 1px solid #ddd;
			}
			.text-right {
				text-align: right;
			}
			.text-center {
				text-align: center;
			}
			.small {
				font-size: 10px;
			}

			/* --- Summary card (totals block) --- */
			.summary-card {
				width: 360px;
				margin-left: auto;
				border-top: 1px solid #ddd;
				padding-top: 12px;
			}
			.summary-row {
				display: flex;
				justify-content: space-between;
				align-items: baseline;
				padding: 6px 0;
			}
			.summary-row.total {
				border-top: 1px solid #ddd;
				margin-top: 6px;
				padding-top: 8px;
				font-weight: 700;
			}
			.summary-row.due {
				border-top: 1px solid #111;
				margin-top: 6px;
				padding-top: 10px;
				font-size: 14px;
				font-weight: 700;
			}
			.summary-label {
				color: #444;
			}
			.summary-value {
				text-align: right;
				min-width: 140px;
			}

			/* Wkhtmltopdf : éviter les sauts disgracieux */
			.avoid-break {
				page-break-inside: avoid;
			}

			.footer {
				position: fixed;
				bottom: 0;
				left: 0;
				right: 0;
				font-size: 10px;
				color: #777;
				border-top: 1px solid #eee;
				padding: 6px 0;
			}
		</style>
	</head>
	<body>
		<div class="container">
			<div class="space-between">
				<div>
					<h1>FACTURE</h1>
					<div class="muted">N°
						{{ invoice.number }}</div>
				</div>
				<div
					class="text-right">{# <img src="{{ asset('build/logo.png') }}" alt="Logo" height="48"> #}
				</div>
			</div>

			<div class="flex mt-16">
				<div class="box" style="flex:1">
					<h2 class="mb-0">{{ company.legalName ?? company.title }}</h2>
					<div class="small">
						{% set a = company.address ?? {} %}
						{{ a.street ?? '' }}<br>
						{{ a.zip ?? '' }}
						{{ a.city ?? '' }}
						{% if a.country is defined and a.country %},
							{{ a.country }}
						{% endif %}<br>
						{% if company.email %}Email:
							{{ company.email }}<br>
						{% endif %}
						{% if company.phone %}Tél:
							{{ company.phone }}<br>
						{% endif %}
						{% if company.siren %}
							SIREN:
							{{ company.siren }}
							{% if company.rcsNumber %}
								— RCS:
								{{ company.rcsNumber }}
							{% endif %}<br>
						{% endif %}
						{% if company.vatNumber %}TVA intracom:
							{{ company.vatNumber }}<br>
						{% endif %}
						Devise par défaut:
						{{ company.defaultCurrency }}
					</div>
				</div>

				<div class="box" style="flex:1">
					<h2 class="mb-0">Facturer à</h2>
					{% set cust = customer ?? invoice.customer %}
					<div class="small">
						<strong>{{ cust.title }}</strong><br>
						{% set b = cust.billingAddress ?? {} %}
						{{ b.street ?? '' }}<br>
						{{ b.zip ?? '' }}
						{{ b.city ?? '' }}
						{% if b.country is defined and b.country %},
							{{ b.country }}
						{% endif %}<br>
						{% if cust.vatNumber %}TVA intracom client:
							{{ cust.vatNumber }}<br>
						{% endif %}
						{% if cust.email %}Email:
							{{ cust.email }}
						{% endif %}
					</div>
				</div>

				<div class="box" style="flex:1">
					<h2 class="mb-0">Détails</h2>
					<div class="small">
						Date d’émission :
						{{ invoice.issueDate|date('d/m/Y') }}<br>
						Date d’échéance :
						{{ invoice.dueDate|date('d/m/Y') }}<br>
						Statut :
						{{ invoice.status.value|capitalize }}
					</div>
				</div>
			</div>

			<div class="mt-16 avoid-break">
				<table>
					<thead>
						<tr>
							<th style="width:40%">Description</th>
							<th class="text-right" style="width:10%">Qté</th>
							<th class="text-right" style="width:15%">PU HT</th>
							<th class="text-right" style="width:10%">Remise</th>
							<th class="text-right" style="width:10%">TVA</th>
							<th class="text-right" style="width:15%">Total HT</th>
						</tr>
					</thead>
					<tbody>
						{% for line in invoice.lines %}
							{# Quantité et montants en centimes #}
							{% set qty      = (line.quantity ?? 1) * 1 %}
							{% set unit     = (line.unitPriceCents ?? 0) + 0 %}
							{% set gross    = (qty * unit)|round(0, 'common') %}
							{% set discount = (line.discountCents ?? 0) + 0 %}
							{% set net      = gross - discount %}

							{# Taux TVA: accepte 19.6 (déjà %) ou 0.196 (ratio) #}
							{% set rawRate     = line.taxRate ? line.taxRate.percent : 0 %}
							{% set rateNum     = (rawRate + 0) %}
							{% set ratePercent = rateNum > 1 ? rateNum : (rateNum * 100) %}

							<tr>
								<td>{{ line.designation }}</td>
								<td class="text-right">{{ qty|number_format(0, ',', ' ') }}</td>
								<td class="text-right">{{ ui.money(unit, invoice.currency) }}</td>
								<td class="text-right">
									{% if discount > 0 %}-{{ ui.money(discount, invoice.currency) }}{% else %}—
									{% endif %}
								</td>
								<td class="text-right">{{ ratePercent|number_format(2, ',', ' ') }}
									%</td>
								<td class="text-right">{{ ui.money(net, invoice.currency) }}</td>
							</tr>
						{% else %}
							<tr>
								<td colspan="6" class="text-center muted">Aucune ligne</td>
							</tr>
						{% endfor %}
					</tbody>
				</table>
			</div>

			{# === Préparation des totaux & ventilation TVA === #}
			{% set totalNet   = invoice.totalNet ?? 0 %}
			{% set totalVat   = invoice.totalVat ?? 0 %}
			{% set totalGross = invoice.totalGross ?? (totalNet + totalVat) %}

			{# Ventilation de la TVA par taux (clé: "19.60", "5.50", etc.) #}
			{% set taxBreakdown = {} %}
			{% for line in invoice.lines %}
				{% set qty      = (line.quantity ?? 1) * 1 %}
				{% set unit     = (line.unitPriceCents ?? 0) + 0 %}
				{% set gross    = (qty * unit)|round(0, 'common') %}
				{% set discount = (line.discountCents ?? 0) + 0 %}
				{% set base     = gross - discount %}

				{% set rawRate     = line.taxRate ? line.taxRate.percent : 0 %}
				{% set rateNum     = (rawRate + 0) %}
				{# nombre Twig #}
				{% set ratePercent = rateNum > 1 ? rateNum : (rateNum * 100) %}
				{% set rateKey     = ratePercent|number_format(2, '.', '') %}

				{% set rateDecimal = rateNum > 1 ? (rateNum / 100) : rateNum %}
				{% set vat         = (base * rateDecimal)|round(0, 'common') %}

				{% set current = taxBreakdown[rateKey]|default({'base':0,'vat':0}) %}
				{% set current = {'base': current.base + base, 'vat': current.vat + vat} %}
				{% set taxBreakdown = taxBreakdown|merge({ (rateKey): current }) %}
			{% endfor %}

			{# Montant payé & dû (si tu ne gères pas encore les paiements, laisse paid=0) #}
			{% set paid = invoice.amountPaid ?? 0 %}
			{% set due  = totalGross - paid %}

			{# --- Résumé des totaux (à droite), avec ventilation TVA par taux --- #}
			<div class="mt-16 avoid-break">
				<div class="summary-card">
					<div class="summary-row">
						<div class="summary-label">Sous-total HT</div>
						<div class="summary-value">{{ ui.money(totalNet, invoice.currency) }}</div>
					</div>

					{% set sortedRates = taxBreakdown|keys|sort %}
					{% for rate in sortedRates %}
						{% set sums = taxBreakdown[rate] %}
						<div class="summary-row">
							<div class="summary-label">
								TVA
								{{ rate|number_format(2, ',', ' ') }}
								% de
								{{ ui.money(sums.base, invoice.currency) }}
							</div>
							<div class="summary-value">{{ ui.money(sums.vat, invoice.currency) }}</div>
						</div>
					{% endfor %}

					<div class="summary-row total">
						<div class="summary-label">Montant Total
							{{ invoice.currency }}</div>
						<div class="summary-value">
							<strong>{{ ui.money(totalGross, invoice.currency) }}</strong>
						</div>
					</div>

					<div class="summary-row">
						<div class="summary-label">Montant payé</div>
						<div class="summary-value">{{ ui.money(paid, invoice.currency) }}</div>
					</div>

					<div class="summary-row due">
						<div class="summary-label">Montant à payer ({{ invoice.currency }})</div>
						<div class="summary-value">{{ ui.money(due, invoice.currency) }}</div>
					</div>
				</div>
			</div>


			<div class="mt-24 small muted">
				Document généré le
				{{ "now"|date("d/m/Y H:i") }}.
			</div>
		</div>

		<div class="footer text-center">
			{{ company.legalName ?? company.title }}
			—
			{{ company.website ?? '' }}
		</div>
	</body>
</html>
